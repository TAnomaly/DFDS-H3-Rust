<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H3 Hexagon Heatmap - Kepler.gl Style</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: #0f1419;
            color: white;
            overflow: hidden;
        }
        .container {
            position: relative;
            height: 100vh;
            width: 100vw;
        }
        .sidebar {
            position: absolute;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: rgba(15, 20, 25, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .sidebar h1 {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 20px 0;
            color: #ffffff;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #00d4ff;
            display: block;
        }
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        .controls {
            margin-bottom: 30px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            display: block;
        }
        .slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
        }
        .legend {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }
        .legend h3 {
            font-size: 14px;
            margin: 0 0 15px 0;
            color: #ffffff;
        }
        .legend-gradient {
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(90deg, 
                #440154 0%, 
                #482777 12.5%, 
                #3f4a8a 25%, 
                #31678e 37.5%, 
                #26838f 50%, 
                #1f9d8a 62.5%, 
                #6cce5a 75%, 
                #b6de2b 87.5%, 
                #fee825 100%
            );
            margin-bottom: 10px;
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
        }
        #map {
            position: absolute;
            left: 300px;
            top: 0;
            right: 0;
            bottom: 0;
            background: #0f1419;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #00d4ff;
            font-size: 16px;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 212, 255, 0.3);
            border-top: 3px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toggle-btn {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .toggle-btn:hover {
            background: rgba(0, 212, 255, 0.3);
        }
        .toggle-btn.active {
            background: #00d4ff;
            color: #0f1419;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>üó∫Ô∏è H3 Hexagon Heatmap</h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalUsers">-</span>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalCells">-</span>
                    <div class="stat-label">H3 Cells</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="resolution">-</span>
                    <div class="stat-label">Resolution</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="maxDensity">-</span>
                    <div class="stat-label">Max Density</div>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label class="control-label">Hexagon Opacity</label>
                    <input type="range" id="opacitySlider" class="slider" min="0" max="1" step="0.1" value="0.8">
                </div>
                
                <div class="control-group">
                    <label class="control-label">Hexagon Size</label>
                    <input type="range" id="sizeSlider" class="slider" min="0.5" max="2" step="0.1" value="1">
                </div>

                <div class="control-group">
                    <button id="toggleLabels" class="toggle-btn">Show Labels</button>
                    <button id="toggleAnimation" class="toggle-btn">Enable Animation</button>
                    <button id="refreshData" class="toggle-btn">Refresh Data</button>
                </div>
            </div>

            <div class="legend">
                <h3>User Density</h3>
                <div class="legend-gradient"></div>
                <div class="legend-labels">
                    <span>Low</span>
                    <span>Medium</span>
                    <span>High</span>
                </div>
            </div>
        </div>

        <div id="map"></div>
        
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            Loading H3 heatmap data...
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
    <script>
        let map;
        let hexagonLayers = [];
        let heatmapData = [];
        let currentOpacity = 0.8;
        let currentSize = 1;
        let showLabels = false;
        let animationEnabled = false;

        // Viridis color palette for better visualization
        const viridisColors = [
            '#440154', '#482777', '#3f4a8a', '#31678e', '#26838f',
            '#1f9d8a', '#6cce5a', '#b6de2b', '#fee825'
        ];

        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([39.9334, 32.8597], 6);
            
            // Dark theme tile layer
            L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', {
                attribution: '¬© CartoDB',
                maxZoom: 18
            }).addTo(map);

            // Add zoom control to bottom right
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
        }

        function getViridisColor(value, min, max) {
            if (max === min) return viridisColors[0];
            const normalized = (value - min) / (max - min);
            const index = Math.floor(normalized * (viridisColors.length - 1));
            return viridisColors[Math.min(index, viridisColors.length - 1)];
        }

        function createHexagon(h3Index, userCount, minCount, maxCount) {
            try {
                const boundary = h3.cellToBoundary(h3Index, true);
                const color = getViridisColor(userCount, minCount, maxCount);
                
                const hexagon = L.polygon(boundary, {
                    color: color,
                    fillColor: color,
                    fillOpacity: currentOpacity,
                    weight: 1,
                    opacity: 0.8
                });

                // Enhanced popup with more details
                const center = h3.cellToLatLng(h3Index);
                hexagon.bindPopup(`
                    <div style="color: #333; font-family: Inter, sans-serif;">
                        <h4 style="margin: 0 0 10px 0; color: #0f1419;">H3 Cell Details</h4>
                        <p><strong>H3 Index:</strong> ${h3Index}</p>
                        <p><strong>Users:</strong> ${userCount}</p>
                        <p><strong>Resolution:</strong> ${h3.getResolution(h3Index)}</p>
                        <p><strong>Center:</strong> ${center[0].toFixed(4)}, ${center[1].toFixed(4)}</p>
                        <p><strong>Area:</strong> ~${(h3.cellArea(h3Index, 'km2')).toFixed(2)} km¬≤</p>
                    </div>
                `, {
                    maxWidth: 250
                });

                // Add label if enabled
                if (showLabels) {
                    const labelIcon = L.divIcon({
                        className: 'hexagon-label',
                        html: `<div style="color: white; font-size: 10px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">${userCount}</div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    const marker = L.marker([center[0], center[1]], { icon: labelIcon });
                    hexagonLayers.push(marker);
                    marker.addTo(map);
                }

                // Animation effect
                if (animationEnabled) {
                    hexagon.on('mouseover', function(e) {
                        this.setStyle({
                            weight: 3,
                            fillOpacity: Math.min(currentOpacity + 0.2, 1)
                        });
                    });
                    
                    hexagon.on('mouseout', function(e) {
                        this.setStyle({
                            weight: 1,
                            fillOpacity: currentOpacity
                        });
                    });
                }

                hexagonLayers.push(hexagon);
                hexagon.addTo(map);
                
            } catch (error) {
                console.error('Error creating hexagon:', error);
            }
        }

        function clearHexagons() {
            hexagonLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            hexagonLayers = [];
        }

        function updateVisualization() {
            clearHexagons();
            
            if (heatmapData.cells && heatmapData.cells.length > 0) {
                const userCounts = heatmapData.cells.map(cell => cell.user_count);
                const minCount = Math.min(...userCounts);
                const maxCount = Math.max(...userCounts);

                heatmapData.cells.forEach(cell => {
                    createHexagon(cell.h3_index, cell.user_count, minCount, maxCount);
                });
            }
        }

        async function loadHeatmapData() {
            try {
                const response = await fetch('/api/v1/heatmap');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                heatmapData = await response.json();

                // Update stats
                document.getElementById('totalUsers').textContent = heatmapData.total_users;
                document.getElementById('totalCells').textContent = heatmapData.cells.length;
                document.getElementById('resolution').textContent = heatmapData.resolution;
                
                const maxDensity = Math.max(...heatmapData.cells.map(cell => cell.user_count));
                document.getElementById('maxDensity').textContent = maxDensity;

                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                // Initialize map and visualization
                initMap();
                updateVisualization();

                console.log('H3 Heatmap loaded successfully:', heatmapData);
            } catch (error) {
                console.error('Error loading heatmap:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ff4444;">
                        ‚ùå Error loading data: ${error.message}<br>
                        <small>Make sure the server is running on http://localhost:8080</small>
                    </div>
                `;
            }
        }

        // Event listeners
        document.getElementById('opacitySlider').addEventListener('input', function(e) {
            currentOpacity = parseFloat(e.target.value);
            updateVisualization();
        });

        document.getElementById('sizeSlider').addEventListener('input', function(e) {
            currentSize = parseFloat(e.target.value);
            // This would require more complex implementation for actual size changes
            console.log('Size changed to:', currentSize);
        });

        document.getElementById('toggleLabels').addEventListener('click', function(e) {
            showLabels = !showLabels;
            this.classList.toggle('active');
            this.textContent = showLabels ? 'Hide Labels' : 'Show Labels';
            updateVisualization();
        });

        document.getElementById('toggleAnimation').addEventListener('click', function(e) {
            animationEnabled = !animationEnabled;
            this.classList.toggle('active');
            this.textContent = animationEnabled ? 'Disable Animation' : 'Enable Animation';
            updateVisualization();
        });

        document.getElementById('refreshData').addEventListener('click', function(e) {
            document.getElementById('loading').style.display = 'block';
            clearHexagons();
            loadHeatmapData();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadHeatmapData);
    </script>
</body>
</html>
